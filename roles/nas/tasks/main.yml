---

- name: Install NFS and iSCSI
  dnf:
    name: ['nfs-utils', 'iscsi-initiator-utils']
    state: latest
  
- name: Create iSCSI mount directory
  file:
    path: /export
    state: directory
  when: inventory_hostname in groups.control_nodes

- name: Discover default NAS target
  open_iscsi:
    show_nodes: yes
    discover: yes
    portal: "{{ groups.nas[0] }}.{{ domain_name }}"
  register: discovery
  when: inventory_hostname in groups.control_nodes

- name: Login to discovered target
  open_iscsi:
    login: yes
    target: "{{ discovery.nodes[0] }}"
  register: device
  when: inventory_hostname in groups.control_nodes

- name: Mount
  ansible.posix.mount:
    path: /export
    src: "{{ device.devicenodes[0] }}"
  when: inventory_hostname in groups.control_nodes

- name: Ensure existance of home directory
  file:
    path: /export/home
    state: directory
  when: inventory_hostname in groups.control_nodes

- name: Add NFS exports
  lineinfile:
    path: /etc/exports
    regexp: "^/export/home.*"
    line: "/export/home\t{{ networks.private.cidr }}(rw,sync,no_root_squash)"
  when: inventory_hostname in groups.control_nodes
  notify: Update NFS exports
  
- name: Allow NFS traffic
  ansible.posix.firewalld:
    service: nfs3
    zone: private
    permanent: yes
    state: enabled
  when: inventory_hostname in groups.control_nodes
  notify: Reload firewalld
  
- name: Start and enable NFS service
  service:
    name: nfs-server
    state: started
    enabled: true
  when: inventory_hostname in groups.control_nodes
  
- name: Mount NFS share
  ansible.posix.mount:
    path: /home
    src: "{{ control_aliases.nfs }}.{{ domain_name }}:/export/home"
    opts: rw,sync,hard
    fstype: nfs
    boot: yes
    state: mounted
   
  