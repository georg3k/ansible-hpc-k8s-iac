---

- name: Create ZABBIX bind directory
  file:
    path: /docker/zabbix
    state: directory
    mode: 0775
  when: inventory_hostname in groups.control_nodes

- name: Deploy ZABBIX
  community.docker.docker_compose:
    project_name: 'zabbix'
    definition:
      version: '3'
      services:
        zabbix_postgres:
          container_name: zabbix_postgres
          image: postgres:13.6-alpine
          volumes:
            - /docker/zabbix/postgres:/var/lib/postgresql/data
            - /etc/localtime:/etc/localtime:ro
          environment:
            POSTGRES_DB: zabbixdb
            POSTGRES_USER: zabbix
            POSTGRES_PASSWORD: "{{ admin_password }}"
          restart: always
        zabbix_server:
          container_name: zabbix_server
          image: zabbix/zabbix-server-pgsql:5.4.10-alpine
          environment:
            DB_SERVER_HOST: zabbix_postgres
            DB_SERVER_PORT: 5432
            POSTGRES_DB: zabbixdb
            POSTGRES_USER: zabbix
            POSTGRES_PASSWORD: "{{ admin_password }}"
            ZBX_VALUECACHESIZE: 64M
            ZBX_CACHESIZE: 128M
            ZBX_TRENDCACHESIZE: 128M
            ZBX_IPMIPOLLERS: 5
          volumes:
            - /etc/openldap:/etc/openldap:ro
            - /etc/localtime:/etc/localtime:ro
          ports:
            - "10051:10051"
          restart: always
          depends_on:
            - zabbix_postgres
        zabbix_web:
          container_name: zabbix_web
          image: zabbix/zabbix-web-nginx-pgsql:5.4.10-alpine
          volumes:
            - /etc/openldap:/etc/openldap:ro
            - /etc/localtime:/etc/localtime:ro
          ports:
            - "4003:8080"
          environment:
            DB_SERVER_HOST: zabbix_postgres
            DB_SERVER_PORT: 5432
            POSTGRES_DB: zabbixdb
            POSTGRES_USER: zabbix
            POSTGRES_PASSWORD: "{{ admin_password }}"
            ZBX_SERVER_HOST: zabbix_server
            ZBX_SERVER_PORT: 10051
            PHP_TZ: Europe/Moscow
          restart: always
          depends_on:
            - zabbix_postgres
        zabbix_agent:
          container_name: zabbix_agent
          image: zabbix/zabbix-agent:latest
          restart: always
          environment:
            ZBX_HOSTNAME: zabbix_agent
            ZBX_SERVER_HOST: zabbix_server
          ports:
            - 10050:10050
          privileged: true
  when: inventory_hostname in groups.control_nodes
    
- name: Ensure existance of certificates directory
  file:
    path: "/docker/certbot/conf/live/{{ external_subdomains.zabbix }}.{{ domain_name }}"
    state: directory

- name: Check the existence of SLL certificate
  shell: test -e "/docker/certbot/conf/live/{{ external_subdomains.zabbix }}.{{ domain_name }}/privkey.pem"
  register: cert_exists
  ignore_errors: true
  changed_when: false
  when: inventory_hostname in groups.control_nodes

- name: Generate dummy certificates
  shell: |
    openssl req -x509 -nodes -newkey rsa:4096 -days 1 -keyout "/docker/certbot/conf/live/{{ external_subdomains.zabbix }}.{{ domain_name }}/privkey.pem" -out "/docker/certbot/conf/live/{{ external_subdomains.zabbix }}.{{ domain_name }}/fullchain.pem" -subj '/CN=localhost'
  when: ((inventory_hostname in groups.control_nodes) and
        (cert_exists.rc != 0))

- name: Generate NGINX reverse proxy template
  template:
    src: zabbix.conf.j2
    dest: /docker/nginx/sites-enabled/zabbix.conf
    mode: 0600
  when: inventory_hostname in groups.control_nodes
  notify: Restart NGINX

- name: Sync handlers
  meta: flush_handlers

- name: Renew certs
  shell: |
    rm -f /docker/certbot/conf/live/"{{ external_subdomains.lam }}.{{ domain_name }}"/*
    docker exec certbot certbot certonly --webroot -w /var/www/certbot -d "{{ external_subdomains.zabbix }}.{{ domain_name }}" --rsa-key-size 4096 --agree-tos --force-renewal --email "{{ letsencrypt_email }}" -n
  failed_when: False
  when: ((inventory_hostname in groups.control_nodes) and
        (cert_exists.rc != 0))

- name: Sync handlers
  meta: flush_handlers

- name: Wait for ZABBIX to startup
  local_action:
    module: uri
    url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    follow_redirects: all
    method: GET
    validate_certs: no
  register: result
  until: result.status == 200
  retries: 60
  delay: 10
  when: inventory_hostname in groups.control_nodes

- name: Change ZABBIX default password
  community.zabbix.zabbix_user:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: zabbix
    alias: Admin
    passwd: "{{ admin_password }}"
    override_passwd: yes
    usrgrps:
    - Zabbix administrators
    validate_certs: False
    state: present
  register: result
  ignore_errors: True
  failed_when: False
  when: inventory_hostname in groups.control_nodes

- name: Import HASS integration temaplate from XML
  local_action:
    module: community.zabbix.zabbix_template
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    template_xml: "{{ lookup('file', 'hass_receiver.xml') }}"
    state: present
    validate_certs: False
  changed_when: false
  when: inventory_hostname in groups.control_nodes

- name: Update ZABBIX server host entry
  community.zabbix.zabbix_host:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    host_name: "Zabbix server"
    link_templates:
    - "Linux by Zabbix agent"
    - "Zabbix server health"
    - "Template Home Assistant"
    interfaces:
    - type: agent
      main: 1
      useip: 0
      port: '10050'
      dns: zabbix_agent
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Create ZABBIX host groups
  community.zabbix.zabbix_group:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    host_groups:
      - Web cluster nodes
      - Compute cluster nodes
      - NAS
      - UPS
      - CISCO switches
      - Mellanox switches
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Create ZABBIX discovery rule for web cluster nodes
  community.zabbix.zabbix_discovery_rule:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "Web cluster"
    iprange: "{{ networks.private.cidr | ipaddr('address') | ipmath(99) }}-{{ [(networks.private.cidr | ipaddr('address')).split('.')[3] | int + 198, 254] | min }}"
    dchecks:
        - type: Zabbix
          key: "system.hostname"
          name_source: DNS
          ports: '10050'
    validate_certs: False
    state: present
    status: enabled
  when: inventory_hostname in groups.control_nodes

- name: Create ZABBIX discovery rule for compute cluster nodes
  community.zabbix.zabbix_discovery_rule:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "Compute cluster"
    iprange: "{{ networks.private.cidr | ipaddr('address') | ipmath(199) }}-{{ [(networks.private.cidr | ipaddr('address')).split('.')[3] | int + 299, 254] | min }}"
    dchecks:
        - type: Zabbix
          key: "system.hostname"
          name_source: DNS
          ports: '10050'
    validate_certs: False
    state: present
    status: enabled
  when: inventory_hostname in groups.control_nodes

- name: Create ZABBIX discovery rule for NAS
  community.zabbix.zabbix_discovery_rule:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "NAS"
    iprange: "{{ networks.management.cidr | ipaddr('address') | ipmath(69) }}-{{ (networks.management.cidr | ipaddr('address')).split('.')[3] | int + 78 }}"
    dchecks:
        - type: SNMPv2
          snmp_community: hpc
          ports: "161"
          key: iso.3.6.1.2.1.1.1.0
          uniq: no
          name_source: DNS
    validate_certs: False
    state: present
    status: enabled
  when: inventory_hostname in groups.control_nodes

- name: Create ZABBIX discovery rule for UPS
  community.zabbix.zabbix_discovery_rule:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "UPS"
    iprange: "{{ networks.management.cidr | ipaddr('address') | ipmath(89) }}-{{ (networks.management.cidr | ipaddr('address')).split('.')[3] | int + 98 }}"
    dchecks:
        - type: SNMPv2
          snmp_community: hpc
          ports: "161"
          key: iso.3.6.1.2.1.1.1.0
          uniq: no
          name_source: DNS
    validate_certs: False
    state: present
    status: enabled
  when: inventory_hostname in groups.control_nodes

- name: Create ZABBIX discovery rule for CISCO switches
  community.zabbix.zabbix_discovery_rule:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "CISCO switches"
    iprange: "{{ networks.private.cidr | ipaddr('address') | ipmath(79) }}-{{ (networks.private.cidr | ipaddr('address')).split('.')[3] | int + 88 }}"
    dchecks:
        - type: SNMPv2
          snmp_community: hpc
          ports: "161"
          key: iso.3.6.1.2.1.1.1.0
          uniq: no
          name_source: DNS
    validate_certs: False
    state: present
    status: enabled
  when: inventory_hostname in groups.control_nodes

- name: Create ZABBIX discovery rule for Mellanox switches
  community.zabbix.zabbix_discovery_rule:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "Mellanox switches"
    iprange: "{{ networks.management.cidr | ipaddr('address') | ipmath(89) }}-{{ (networks.management.cidr | ipaddr('address')).split('.')[3] | int + 98 }}"
    dchecks:
        - type: SNMPv2
          snmp_community: hpc
          ports: "161"
          key: iso.3.6.1.2.1.1.1.0
          uniq: no
          name_source: DNS
    validate_certs: False
    state: present
    status: enabled
  when: inventory_hostname in groups.control_nodes

- name: Create discovery action for web cluster
  community.zabbix.zabbix_action:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "Web cluster group"
    event_source: 'discovery'
    state: present
    status: enabled
    esc_period: '60'
    conditions:
      - type: 'discovery_rule'
        operator: '='
        value: 'Web cluster'
      - type: 'discovered_service_type'
        operator: '='
        value: 'Zabbix agent'
    operations:
      - type: add_host
      - type: add_to_host_group
        host_groups: 'Web cluster nodes'
      - type: link_to_template
        templates:
          - 'Linux by Zabbix agent'
      - type: link_to_template
        templates:
          - 'Chassis by IPMI'
      - type: set_host_inventory_mode
        inventory: automatic
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Create discovery action for compute cluster
  community.zabbix.zabbix_action:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "Compute cluster group"
    event_source: 'discovery'
    state: present
    status: enabled
    esc_period: '60'
    conditions:
      - type: 'discovery_rule'
        operator: '='
        value: 'Compute cluster'
      - type: 'discovered_service_type'
        operator: '='
        value: 'Zabbix agent'
    operations:
      - type: add_host
      - type: add_to_host_group
        host_groups: 'Compute cluster nodes'
      - type: link_to_template
        templates:
          - 'Linux by Zabbix agent'
      - type: link_to_template
        templates:
          - 'Chassis by IPMI'
      - type: set_host_inventory_mode
        inventory: automatic
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Create discovery action for NAS
  community.zabbix.zabbix_action:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "NAS group"
    event_source: 'discovery'
    state: present
    status: enabled
    esc_period: '60'
    conditions:
      - type: 'discovery_rule'
        operator: '='
        value: 'NAS'
    operations:
      - type: add_host
      - type: add_to_host_group
        host_groups: 'NAS'
      - type: link_to_template
        templates:
          - 'Generic SNMP' 
      - type: set_host_inventory_mode
        inventory: automatic
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Create discovery action for UPS
  community.zabbix.zabbix_action:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "UPS group"
    event_source: 'discovery'
    state: present
    status: enabled
    esc_period: '60'
    conditions:
      - type: 'discovery_rule'
        operator: '='
        value: 'UPS'
    operations:
      - type: add_host
      - type: add_to_host_group
        host_groups: 'UPS'
      - type: link_to_template
        templates:
          - 'APC UPS SNMP'
      - type: set_host_inventory_mode
        inventory: automatic
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Create discovery action for CISCO switches
  community.zabbix.zabbix_action:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "CISCO switches group"
    event_source: 'discovery'
    state: present
    status: enabled
    esc_period: '60'
    conditions:
      - type: 'discovery_rule'
        operator: '='
        value: 'CISCO switches'
    operations:
      - type: add_host
      - type: add_to_host_group
        host_groups: 'CISCO switches'
      - type: link_to_template
        templates:
          - 'Cisco IOS SNMP'
      - type: set_host_inventory_mode
        inventory: automatic
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Create discovery action for Mellanox switches
  community.zabbix.zabbix_action:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "Mellanox switches group"
    event_source: 'discovery'
    state: present
    status: enabled
    esc_period: '60'
    conditions:
      - type: 'discovery_rule'
        operator: '='
        value: 'Mellanox switches'
    operations:
      - type: add_host
      - type: add_to_host_group
        host_groups: 'Mellanox switches'
      - type: link_to_template
        templates:
          - 'Mellanox SNMP' 
      - type: set_host_inventory_mode
        inventory: automatic
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Setup ZABBIX Telegram bot
  community.zabbix.zabbix_mediatype:
    name: "Telegram"
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    type: 'webhook'
    webhook_script: "{{ lookup('file', 'telebot.js') }}"
    webhook_params:
      - name: 'Message'
        value: '{ALERT.MESSAGE}'
      - name: 'ParseMode'
        value: ''
      - name: 'Subject'
        value: '{ALERT.SUBJECT}'
      - name: 'To'
        value: '{ALERT.SENDTO}'
      - name: 'Token'
        value: "{{ telegram_token }}"
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Create ZABBIX admin user group
  community.zabbix.zabbix_usergroup:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "Admins"
    gui_access: LDAP
    rights:
      - host_group: "Zabbix servers"
        permission: read-write
      - host_group: "Web cluster nodes"
        permission: read-write
      - host_group: "Compute cluster nodes"
        permission: read-write
      - host_group: "UPS"
        permission: read-write
      - host_group: "NAS"
        permission: read-write
      - host_group: "CISCO switches"
        permission: read-write
      - host_group: "Mellanox switches"
        permission: read-write
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Create ZABBIX regular user group
  community.zabbix.zabbix_usergroup:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "Users"
    gui_access: LDAP
    rights:
      - host_group: "Zabbix servers"
        permission: read-only
      - host_group: "Web cluster nodes"
        permission: read-only
      - host_group: "Compute cluster nodes"
        permission: read-only
      - host_group: "UPS"
        permission: read-only
      - host_group: "NAS"
        permission: read-only
      - host_group: "CISCO switches"
        permission: read-only
      - host_group: "Mellanox switches"
        permission: read-only
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Enable messages trigger action
  community.zabbix.zabbix_action:
    server_url: "https://{{ external_subdomains.zabbix }}.{{ domain_name }}"
    login_user: Admin
    login_password: "{{ admin_password }}"
    name: "Report problems to administrators"
    event_source: 'trigger'
    state: present
    status: enabled
    esc_period: '60'
    operations:
      - type: send_message
        send_to_groups:
          - 'Admins'
    validate_certs: False
  when: inventory_hostname in groups.control_nodes

- name: Install EPEL
  dnf:
    name: 'epel-release'
    state: latest
  when: inventory_hostname not in groups.control_nodes

- name: Install ZABBIX agent
  dnf:
    name: ['zabbix40-agent']
    state: latest
  when: inventory_hostname not in groups.control_nodes

- name: Copy ZABBIX agent configuration
  template:
    src: zabbix_agentd.conf.j2
    dest: /etc/zabbix_agentd.conf
    mode: 644
  when: inventory_hostname not in groups.control_nodes
  
- name: Start and enable ZABBIX agent
  service:
    name: zabbix-agent
    state: started
    enabled: true
  when: inventory_hostname not in groups.control_nodes

#- name: Allow ZABBIX agent traffic
#  ansible.posix.firewalld:
#    port: 10050/tcp
#    zone: private
#    permanent: yes
#    state: enabled
#  notify: Reload firewalld
#  when: inventory_hostname not in groups.control_nodes

- name: Install ZABBIX LDAP sync script dnf dependencies
  dnf:
    name: ['gcc-toolset-11', 'python3-devel', 'openldap-devel']
    state: latest
  when: inventory_hostname in groups.control_nodes

- name: Install ZABBIX LDAP sync script pip dependencies
  pip:
    name: 'python-ldap'
  when: inventory_hostname in groups.control_nodes

- name: Copy ZABBIX LDAP sync script
  copy:
    src: zabbix-ldap-sync.py
    dest: /root/zabbix-ldap-sync.py
    mode: 700
  when: inventory_hostname in groups.control_nodes

- name: Generate ZABBIX LDAP sync config file
  template:
    src: zabbix-ldap-sync.json.j2
    dest: /root/zabbix-ldap-sync.json
    mode: 400
  when: inventory_hostname in groups.control_nodes

- name: Enable sync script to run every minute
  cron:
    name: "Sync ZABBIX with LDAP"
    minute: '*/30'
    user: root
    job: "/root/zabbix-ldap-sync.py"
    cron_file: zabbix_ldap
  when: inventory_hostname in groups.control_nodes
